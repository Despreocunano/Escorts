---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

const { data: { session } } = await supabase.auth.getSession();

if (session) {
  return Astro.redirect('/admin');
}

const error = Astro.url.searchParams.get('error');
---

<Layout title="Iniciar Sesión - Admin">
  <div class="min-h-screen bg-black text-white pt-36">
    <div class="max-w-md mx-auto px-6">
      <h1 class="text-2xl font-light text-center mb-8">Iniciar Sesión</h1>

      {error === 'unauthorized' && (
        <div class="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded mb-6">
          No tienes permisos de administrador
        </div>
      )}

      <form id="loginForm" class="bg-[#1A1A1A] rounded-lg p-6">
        <div class="mb-4">
          <label for="email" class="block text-sm text-gray-400 mb-2">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full bg-black/50 text-white px-4 py-2 rounded border border-white/10 focus:outline-none focus:border-[#9F8E6A]"
          />
        </div>

        <div class="mb-6">
          <label for="password" class="block text-sm text-gray-400 mb-2">Contraseña</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="w-full bg-black/50 text-white px-4 py-2 rounded border border-white/10 focus:outline-none focus:border-[#9F8E6A]"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-[#9F8E6A] hover:bg-[#8A7A5C] text-white py-2 rounded transition-colors"
        >
          Iniciar Sesión
        </button>

        <div id="errorMessage" class="mt-4 text-red-400 text-sm text-center hidden"></div>
      </form>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  const form = document.getElementById('loginForm');
  const errorMessage = document.getElementById('errorMessage');

  if (form && errorMessage) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form as HTMLFormElement);
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        if (data.user) {
          const { data: adminCheck } = await supabase
            .from('admins')
            .select('id')
            .eq('id', data.user.id)
            .single();

          if (!adminCheck) {
            await supabase.auth.signOut();
            throw new Error('No tienes permisos de administrador');
          }

          window.location.href = '/admin';
        }
      } catch (error) {
        errorMessage.textContent = error instanceof Error ? error.message : 'Error al iniciar sesión';
        errorMessage.classList.remove('hidden');
      }
    });
  }
</script>